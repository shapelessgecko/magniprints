<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order - MagniPrints</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Enhanced track page styles */
        .eta-box {
            background: linear-gradient(135deg, var(--accent) 0%, #9333ea 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            margin-top: 1.5rem;
        }
        
        .eta-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.9;
        }
        
        .eta-time {
            font-size: 2rem;
            font-weight: 800;
            margin-top: 0.5rem;
        }
        
        .layer-info {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }
        
        .layer-info-row {
            display: flex;
            justify-content: space-between;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .layer-info-label {
            opacity: 0.7;
        }
        
        .layer-info-value {
            color: var(--accent);
            font-weight: 600;
        }
        
        .printer-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg);
            border-radius: 12px;
            margin-top: 1rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #22c55e;
            animation: statusPulse 2s infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .nozzle-temp {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }
        
        .progress-detail {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .order-details {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .order-details h4 {
            margin-bottom: 1rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            opacity: 0.7;
        }
        
        .order-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .order-detail-row:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="logo">MagniPrints</div>
        <ul class="nav-links">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../products/">Products</a></li>
            <li><a href="../custom/">Custom Print</a></li>
            <li><a href="./">Track Order</a></li>
        </ul>
        <div class="nav-controls">
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                <span id="themeIcon">‚òÄÔ∏è</span>
            </button>
            <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
        </div>
    </nav>

    <section class="track-section">
        <div class="track-header reveal">
            <h1 class="section-title">Track Your Print</h1>
            <p class="section-subtitle">Monitor your order in real-time with 3D visualization</p>
        </div>

        <!-- Order Input -->
        <div class="order-input-group reveal">
            <input type="text" class="order-input" id="orderInput" placeholder="Enter Order ID (e.g., MP-2024-001)" maxlength="12">
            <button class="track-btn" onclick="trackOrder()">Track</button>
        </div>

        <!-- Tracking Display -->
        <div class="tracking-display" id="trackingDisplay" style="display: none;">
            <!-- 3D Layer Visualization -->
            <div class="layer-visualization" style="position: relative;">
                <canvas id="layerCanvas" style="width: 100%; height: 100%;"></canvas>
                <div class="layer-info">
                    <div class="layer-info-row">
                        <span class="layer-info-label">Layer:</span>
                        <span class="layer-info-value"><span id="currentLayer">0</span> / <span id="totalLayers">0</span></span>
                    </div>
                    <div class="layer-info-row">
                        <span class="layer-info-label">Height:</span>
                        <span class="layer-info-value"><span id="currentHeight">0</span> mm</span>
                    </div>
                    <div class="layer-info-row">
                        <span class="layer-info-label">Speed:</span>
                        <span class="layer-info-value"><span id="printSpeed">60</span> mm/s</span>
                    </div>
                </div>
            </div>

            <!-- Progress Panel -->
            <div class="progress-panel">
                <div class="progress-bar-container">
                    <div class="progress-detail">
                        <span>Print Progress</span>
                        <span><span id="progressPercent">0</span>%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progressBar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Status Steps -->
                <div class="status-steps" id="statusSteps">
                    <div class="status-step completed" data-step="1">
                        <div class="status-icon">üìã</div>
                        <div class="status-label">Received</div>
                    </div>
                    <div class="status-step completed" data-step="2">
                        <div class="status-icon">üñ®Ô∏è</div>
                        <div class="status-label">Queued</div>
                    </div>
                    <div class="status-step active" data-step="3">
                        <div class="status-icon">‚öôÔ∏è</div>
                        <div class="status-label">Printing</div>
                    </div>
                    <div class="status-step" data-step="4">
                        <div class="status-icon">üîç</div>
                        <div class="status-label">QC Check</div>
                    </div>
                    <div class="status-step" data-step="5">
                        <div class="status-icon">üì¶</div>
                        <div class="status-label">Ready</div>
                    </div>
                </div>

                <!-- Print Stats -->
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="statTempHead">200¬∞C</div>
                        <div class="stat-label-small">Nozzle</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statTempBed">60¬∞C</div>
                        <div class="stat-label-small">Bed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statFan">100%</div>
                        <div class="stat-label-small">Fan</div>
                    </div>
                </div>

                <!-- ETA Countdown -->
                <div class="eta-box">
                    <div class="eta-label">Estimated Completion</div>
                    <div class="eta-time" id="etaTime">--:--:--</div>
                </div>

                <!-- Printer Status -->
                <div class="printer-status">
                    <div class="status-indicator"></div>
                    <span style="font-weight: 600;">Printer Active</span>
                    <span class="nozzle-temp" style="margin-left: auto; color: var(--accent);">
                        üå°Ô∏è <span id="liveTemp">200</span>/<span id="targetTemp">200</span>¬∞C
                    </span>
                </div>

                <!-- Order Details -->
                <div class="order-details">
                    <h4>Order Details</h4>
                    <div class="order-detail-row">
                        <span>Order ID</span>
                        <span id="detailOrderId">--</span>
                    </div>
                    <div class="order-detail-row">
                        <span>Product</span>
                        <span id="detailProduct">--</span>
                    </div>
                    <div class="order-detail-row">
                        <span>Material</span>
                        <span id="detailMaterial">--</span>
                    </div>
                    <div class="order-detail-row">
                        <span>Started</span>
                        <span id="detailStarted">--</span>
                    </div>
                    <div class="order-detail-row">
                        <span>Filament Used</span>
                        <span id="detailFilament">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- G-code Terminal -->
        <div class="terminal-window" id="terminalWindow" style="display: none;">
            <div class="terminal-header">
                <span class="terminal-dot red"></span>
                <span class="terminal-dot yellow"></span>
                <span class="terminal-dot green"></span>
                <span class="terminal-title">GCODE Monitor ‚Äî ~/printer.log</span>
            </div>
            <div class="terminal-body" id="terminalBody">
                <!-- Terminal lines will be added here -->
            </div>
        </div>
    </section>

    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        themeToggle.addEventListener('click', () => {
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            document.getElementById('themeIcon').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        });

        // Mobile Menu
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.querySelector('.nav-links').classList.toggle('active');
        });

        // Simulated Order Database
        const orders = {
            'MP-2024-001': {
                product: 'Phone Stand',
                material: 'PLA White',
                started: 'Feb 12, 14:30',
                totalLayers: 147,
                currentLayer: 89,
                totalHeight: 29.4,
                filamentUsed: 42.5,
                filamentTotal: 65,
                printTime: '4h 30m',
                remaining: 98, // minutes
                status: 3, // 1-5
                tempHead: 200,
                tempBed: 60,
                speed: 60,
                fan: 100
            },
            'MP-2024-002': {
                product: 'Geometric Planter',
                material: 'PETG Blue',
                started: 'Feb 12, 10:15',
                totalLayers: 203,
                currentLayer: 203,
                totalHeight: 50.75,
                filamentUsed: 82,
                filamentTotal: 82,
                printTime: '6h 45m',
                remaining: 0,
                status: 4,
                tempHead: 240,
                tempBed: 80,
                speed: 50,
                fan: 80
            },
            'MP-2024-003': {
                product: 'Custom Lithophane',
                material: 'PLA White',
                started: 'Feb 11, 09:00',
                totalLayers: 98,
                currentLayer: 98,
                totalHeight: 19.6,
                filamentUsed: 35,
                filamentTotal: 35,
                printTime: '3h 30m',
                remaining: 0,
                status: 5,
                tempHead: 195,
                tempBed: 60,
                speed: 30,
                fan: 100
            },
            'DEMO': {
                product: 'Controller Stand',
                material: 'TPU Green',
                started: new Date().toLocaleString('en-IN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                totalLayers: 180,
                currentLayer: 1,
                totalHeight: 36.0,
                filamentUsed: 0,
                filamentTotal: 78,
                printTime: '5h 15m',
                remaining: 315,
                status: 3,
                tempHead: 220,
                tempBed: 50,
                speed: 45,
                fan: 100
            }
        };

        let currentOrder = null;
        let updateInterval = null;
        let terminalInterval = null;

        // G-code commands
        const gcodeCommands = [
            'G1 X120.45 Y89.23 E2.456 ; extrude line',
            'G1 F1800 X121.12 Y90.45 E2.512',
            'G1 X122.34 Y91.67 E2.568',
            'G1 X123.56 Y92.89 E2.624',
            'M104 S200 ; hotend temp',
            'M140 S60 ; bed temp',
            'G1 F1500 E2.5 ; retract',
            'G1 X150 Y150 F3000 ; move to next position',
            'G1 X150.2 Y150.3 E2.55 ; resume extrusion',
            'M105 ; report temps',
            'G1 X151 Y151 E2.61',
            'G1 X152 Y152 E2.67',
            'M109 S200 ; wait for temp',
            'G1 Z0.3 F1500 ; next layer',
            'G1 X100 Y100 F3000 ; rapid move',
            'G28 ; home axes',
            'G29 ; auto bed level',
            'M107 ; fan off',
            'M106 S255 ; fan on',
            '; Layer 89 of 180',
            'M73 P49 ; progress update',
            'G2 X120 Y80 I10 J10 F1800 ; arc move',
            'G3 X100 Y100 I-10 J-10 F1800',
            'M105 ; T:200.5 /200 B:60.2 /60',
            'G1 F1200 X125.45 Y95.12 E3.1',
            'G1 X126.34 Y96.23 E3.15',
            'M104 S200.5 ; maintain temp',
            'G1 Z0.4 E3.2 F1500 ; z-hop'
        ];

        function trackOrder() {
            const orderId = document.getElementById('orderInput').value.toUpperCase().trim();
            
            if (!orderId) {
                alert('Please enter an Order ID');
                return;
            }

            // Check for demo or real order
            const order = orders[orderId] || orders['DEMO'];
            currentOrder = order;
            
            // Show tracking display
            document.getElementById('trackingDisplay').style.display = 'grid';
            document.getElementById('terminalWindow').style.display = 'block';

            // Update details
            document.getElementById('detailOrderId').textContent = orderId;
            document.getElementById('detailProduct').textContent = order.product;
            document.getElementById('detailMaterial').textContent = order.material;
            document.getElementById('detailStarted').textContent = order.started;
            document.getElementById('detailFilament').textContent = `${order.filamentTotal}g`;
            document.getElementById('totalLayers').textContent = order.totalLayers;

            // Start visualization
            initLayerVisualization();
            startLiveUpdates();
            startTerminal();

            // Scroll to display
            document.getElementById('trackingDisplay').scrollIntoView({ behavior: 'smooth' });
        }

        // Live updates
        function startLiveUpdates() {
            if (updateInterval) clearInterval(updateInterval);
            
            updateDisplay();
            
            updateInterval = setInterval(() => {
                if (!currentOrder) return;
                
                // Simulate progress
                if (currentOrder.currentLayer < currentOrder.totalLayers) {
                    currentOrder.currentLayer += 1;
                    currentOrder.filamentUsed += currentOrder.filamentTotal / currentOrder.totalLayers;
                    
                    if (currentOrder.remaining > 0) {
                        currentOrder.remaining -= 1;
                    }
                    
                    // Random temp fluctuation
                    currentOrder.tempHead = 200 + (Math.random() - 0.5) * 2;
                }
                
                // Update status if complete
                if (currentOrder.currentLayer >= currentOrder.totalLayers) {
                    currentOrder.status = 5;
                    currentOrder.remaining = 0;
                } else if (currentOrder.currentLayer > currentOrder.totalLayers * 0.95) {
                    currentOrder.status = 4;
                }
                
                updateDisplay();
            }, 2000); // Update every 2 seconds for demo
        }

        function updateDisplay() {
            if (!currentOrder) return;
            
            const progress = Math.round((currentOrder.currentLayer / currentOrder.totalLayers) * 100);
            const currentHeight = (currentOrder.currentLayer / currentOrder.totalLayers * currentOrder.totalHeight).toFixed(1);
            
            // Update layer info
            document.getElementById('currentLayer').textContent = currentOrder.currentLayer;
            document.getElementById('currentHeight').textContent = currentHeight;
            document.getElementById('printSpeed').textContent = currentOrder.speed;
            
            // Update progress
            document.getElementById('progressPercent').textContent = progress;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Update stats
            document.getElementById('statTempHead').textContent = `${currentOrder.tempHead.toFixed(1)}¬∞C`;
            document.getElementById('statTempBed').textContent = `${currentOrder.tempBed}¬∞C`;
            document.getElementById('statFan').textContent = `${currentOrder.fan}%`;
            document.getElementById('liveTemp').textContent = currentOrder.tempHead.toFixed(1);
            document.getElementById('targetTemp').textContent = currentOrder.tempHead.toFixed(0);
            
            // Update filament
            document.getElementById('detailFilament').textContent = 
                `${currentOrder.filamentUsed.toFixed(1)}/${currentOrder.filamentTotal}g`;
            
            // Update ETA
            if (currentOrder.remaining > 0) {
                const hours = Math.floor(currentOrder.remaining / 60);
                const mins = currentOrder.remaining % 60;
                const secs = Math.floor(Math.random() * 59);
                document.getElementById('etaTime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('etaTime').textContent = 'COMPLETE';
            }
            
            // Update status steps
            const steps = document.querySelectorAll('.status-step');
            steps.forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('completed', 'active');
                
                if (stepNum < currentOrder.status) {
                    step.classList.add('completed');
                } else if (stepNum === currentOrder.status) {
                    step.classList.add('active');
                }
            });
            
            // Update 3D visualization
            updateLayerVisualization(progress / 100);
        }

        // Terminal
        function startTerminal() {
            const terminal = document.getElementById('terminalBody');
            terminal.innerHTML = '';
            
            if (terminalInterval) clearInterval(terminalInterval);
            
            // Add initial lines
            addTerminalLine('Connecting to printer...', 'info');
            addTerminalLine('Connection established', 'success');
            addTerminalLine('Marlin 2.1.2 ready', 'info');
            
            terminalInterval = setInterval(() => {
                const cmd = gcodeCommands[Math.floor(Math.random() * gcodeCommands.length)];
                const type = cmd.includes('error') ? 'error' : 
                            cmd.includes('warn') ? 'warning' : '';
                addTerminalLine(`> ${cmd}`, type);
            }, 800);
        }

        function addTerminalLine(text, type = '') {
            const terminal = document.getElementById('terminalBody');
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-GB');
            line.className = `terminal-line ${type}`;
            line.textContent = `[${time}] ${text}`;
            terminal.appendChild(line);
            
            // Keep only last 50 lines
            while (terminal.children.length > 50) {
                terminal.removeChild(terminal.firstChild);
            }
            
            terminal.scrollTop = terminal.scrollHeight;
        }

        // Three.js Layer Visualization
        let layerScene, layerCamera, layerRenderer, layerModel;

        function initLayerVisualization() {
            const canvas = document.getElementById('layerCanvas');
            const container = canvas.parentElement;
            
            layerScene = new THREE.Scene();
            layerScene.background = new THREE.Color(getComputedStyle(document.body).getPropertyValue('--card').trim() || 0x0a0a0a);
            
            layerCamera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
            layerCamera.position.set(4, 3, 4);
            layerCamera.lookAt(0, 0, 0);
            
            layerRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            layerRenderer.setSize(container.clientWidth, container.clientHeight);
            
            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            layerScene.add(ambient);
            
            const dir = new THREE.DirectionalLight(0x667eea, 0.8);
            dir.position.set(3, 5, 2);
            layerScene.add(dir);
            
            const back = new THREE.DirectionalLight(0x9333ea, 0.3);
            back.position.set(-3, -2, -2);
            layerScene.add(back);
            
            // Create stacked layers visualization
            createLayerStack();
            
            animateLayers();
        }

        function createLayerStack() {
            layerModel = new THREE.Group();
            
            const totalLayers = 20;
            const baseSize = 1.5;
            const heightStep = 0.15;
            
            for (let i = 0; i < totalLayers; i++) {
                // Create a pattern that represents a simple object
                const progress = i / totalLayers;
                const size = baseSize * (0.8 + 0.4 * Math.sin(progress * Math.PI));
                
                // Layer geometry
                const geometry = new THREE.BoxGeometry(size, heightStep * 0.8, size * 0.8);
                
                // Gradient color based on layer
                const hue = 0.65 + (progress * 0.15); // Blue to purple
                const color = new THREE.Color().setHSL(hue, 0.8, 0.5);
                
                const material = new THREE.MeshStandardMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.9,
                    roughness: 0.5,
                    metalness: 0.2
                });
                
                const layer = new THREE.Mesh(geometry, material);
                layer.position.y = i * heightStep;
                layer.userData.layerIndex = i;
                layer.userData.originalOpacity = 0.9;
                
                layerModel.add(layer);
            }
            
            // Grid
            const grid = new THREE.GridHelper(6, 20, 0x667eea, 0x334155);
            grid.position.y = -0.5;
            layerScene.add(grid);
            
            layerScene.add(layerModel);
        }

        function updateLayerVisualization(progress) {
            if (!layerModel) return;
            
            const layers = layerModel.children.filter(c => c.userData.layerIndex !== undefined);
            const completedCount = Math.floor(progress * layers.length);
            
            layers.forEach((layer, index) => {
                if (index < completedCount) {
                    // Completed layers
                    layer.material.opacity = 1;
                    layer.material.emissive.setHex(0x222244);
                    layer.position.z = 0;
                } else if (index === completedCount) {
                    // Current layer - highlight
                    layer.material.opacity = 1;
                    layer.material.emissive.setHex(0x4444ff);
                    layer.position.z = 0.1;
                } else {
                    // Future layers - fade
                    layer.material.opacity = 0.3;
                    layer.material.emissive.setHex(0x000000);
                    layer.position.z = 0;
                }
            });
        }

        function animateLayers() {
            if (!layerRenderer) return;
            requestAnimationFrame(animateLayers);
            
            // Gentle rotation
            if (layerModel) {
                layerModel.rotation.y += 0.005;
            }
            
            layerRenderer.render(layerScene, layerCamera);
        }

        // Resize handler
        window.addEventListener('resize', () => {
            if (layerRenderer && layerCamera) {
                const container = document.querySelector('.layer-visualization');
                const size = Math.min(container.clientWidth, container.clientHeight);
                layerRenderer.setSize(size, size);
                layerCamera.aspect = 1;
                layerCamera.updateProjectionMatrix();
            }
        });

        // Scroll reveal
        const reveals = document.querySelectorAll('.reveal');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        });
        reveals.forEach(el => observer.observe(el));

        // Enter key triggers search
        document.getElementById('orderInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') trackOrder();
        });

        // Add initial terminal log
        addTerminalLine('System initialized. Waiting for input...', 'info');
    </script>
</body>
</html>
