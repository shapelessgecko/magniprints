<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Track Order | MAGNIPRINTS</title>
  <meta name="description" content="Track your 3D print order status in real-time.">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Sans+JP:wght@700;900&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  
  <link rel="stylesheet" href="../css/theme.css">
  
  <style>
    .track-page {
      min-height: 100vh;
      padding-top: 100px;
      padding-bottom: 4rem;
    }
    
    .page-header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 0 2rem;
    }
    
    .page-header h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    
    .back-link:hover {
      color: var(--accent);
    }
    
    /* Search Bar */
    .search-section {
      max-width: 600px;
      margin: 0 auto 3rem;
      padding: 0 2rem;
    }
    
    .search-box {
      display: flex;
      gap: 0.75rem;
    }
    
    .search-input {
      flex: 1;
      padding: 1rem 1.5rem;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 16px;
      color: var(--text-primary);
      font-size: 1rem;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    
    .search-btn {
      padding: 1rem 1.5rem;
      background: var(--accent);
      border: none;
      border-radius: 16px;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px var(--accent-glow);
    }
    
    .demo-hint {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .demo-hint span {
      cursor: pointer;
      color: var(--accent);
      text-decoration: underline;
    }
    
    /* Order Status Display */
    .order-display {
      display: none;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
      animation: fadeIn 0.5s ease;
    }
    
    .order-display.visible {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Order Header */
    .order-header {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .order-id h2 {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    
    .order-id p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    
    .order-status-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: var(--accent);
      border-radius: 50px;
      font-weight: 600;
      color: white;
    }
    
    .order-status-badge.pending {
      background: var(--warning);
      color: black;
    }
    
    .order-status-badge.ready {
      background: var(--success);
    }
    
    /* Main Grid */
    .track-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
    }
    
    /* 3D Layer Visualization */
    .layer-viz {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
    }
    
    .layer-viz h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .viz-canvas {
      width: 100%;
      height: 350px;
      background: var(--bg-secondary);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }
    
    #layerCanvas {
      width: 100%;
      height: 100%;
    }
    
    .progress-overlay {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(0, 0, 0, 0.7);
      padding: 0.75rem 1rem;
      border-radius: 10px;
      color: white;
    }
    
    .progress-pct {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .progress-text {
      font-size: 0.75rem;
      opacity: 0.8;
    }
    
    /* Status Tracker */
    .status-tracker {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .status-tracker h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .steps {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    
    .step {
      display: flex;
      gap: 1rem;
      position: relative;
      padding-bottom: 1.5rem;
    }
    
    .step:last-child {
      padding-bottom: 0;
    }
    
    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 16px;
      top: 32px;
      width: 2px;
      height: calc(100% - 16px);
      background: var(--border);
    }
    
    .step.completed:not(:last-child)::after {
      background: var(--accent);
    }
    
    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 0.9rem;
      z-index: 1;
    }
    
    .step.completed .step-dot {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .step.active .step-dot {
      background: var(--bg-card);
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
      animation: pulse-dot 2s infinite;
    }
    
    @keyframes pulse-dot {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .step-content {
      flex: 1;
    }
    
    .step-title {
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .step-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
    
    .step-time {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    
    /* Side Panel */
    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    /* Print Stats */
    .print-stats-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
    }
    
    .print-stats-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .stat-row:last-child {
      border-bottom: none;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .stat-value {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .temp-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: blink 2s infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* ETA Card */
    .eta-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
    }
    
    .eta-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .countdown {
      text-align: center;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border-radius: 12px;
    }
    
    .countdown-main {
      font-size: 2.5rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }
    
    .countdown-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
    
    /* G-Code Stream */
    .gcode-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
    }
    
    .gcode-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .gcode-terminal {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1rem;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.75rem;
      height: 150px;
      overflow: hidden;
      color: var(--text-secondary);
    }
    
    .gcode-line {
      line-height: 1.6;
    }
    
    .gcode-line.active {
      color: var(--accent);
    }
    
    .gcode-comment {
      color: var(--text-muted);
    }
    
    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .track-grid {
        grid-template-columns: 1fr;
      }
      
      .viz-canvas {
        height: 250px;
      }
    }
    
    @media (max-width: 640px) {
      .order-header {
        flex-direction: column;
        text-align: center;
      }
      
      .search-box {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav-container">
    <a href="../index.html" class="logo">
      <span>‚óâ</span> MAGNIPRINTS
    </a>
    <ul class="nav-links">
      <li><a href="../index.html">Home</a></li>
      <li><a href="../products/index.html">Products</a></li>
      <li><a href="../custom/index.html">Custom</a></li>
      <li><a href="index.html">Track</a></li>
    </ul>
  </nav>

  <div class="track-page">
    <div class="page-header">
      <a href="../index.html" class="back-link">‚Üê Back to Home</a>
      <h1>Track Your <span class="text-gradient">Order</span></h1>
      <p>Enter your order ID to check real-time status</p>
    </div>
    
    <!-- Search Section -->
    <div class="search-section">
      <div class="search-box">
        <input type="text" class="search-input" id="orderInput" placeholder="MP-XXX" maxlength="10">
        <button class="search-btn" id="trackBtn">Track</button>
      </div>
      <p class="demo-hint">
        Try demo orders: <span onclick="fillOrder('MP-001')">MP-001</span>, 
        <span onclick="fillOrder('MP-002')">MP-002</span>, 
        <span onclick="fillOrder('MP-003')">MP-003</span>
      </p>
    </div>
    
    <!-- Order Display -->
    <div class="order-display" id="orderDisplay">
      <div class="order-header">
        <div class="order-id">
          <h2 id="displayOrderId">MP-001</h2>
          <p>Placed on Jan 15, 2026 ‚Ä¢ Controller Stand x 2</p>
        </div>
        <div class="order-status-badge" id="statusBadge">
          <span class="temp-indicator"></span>
          <span id="statusText">Printing</span>
        </div>
      </div>
      
      <div class="track-grid">
        <div class="main-col">
          <!-- 3D Layer Visualization -->
          <div class="layer-viz">
            <h3>üñ®Ô∏è Live Print Visualization</h3>
            <div class="viz-canvas">
              <canvas id="layerCanvas"></canvas>
              <div class="progress-overlay">
                <div class="progress-pct" id="progressPct">67%</div>
                <div class="progress-text" id="progressText">Layer 134/200</div>
              </div>
            </div>
          </div>
          
          <!-- Status Tracker -->
          <div class="status-tracker">
            <h3>üìã Order Progress</h3>
            <div class="steps" id="stepsContainer">
              <div class="step completed">
                <div class="step-dot">‚úì</div>
                <div class="step-content">
                  <div class="step-title">Order Received</div>
                  <div class="step-desc">Your order has been confirmed</div>
                  <div class="step-time">Jan 15, 9:30 AM</div>
                </div>
              </div>
              <div class="step completed">
                <div class="step-dot">‚úì</div>
                <div class="step-content">
                  <div class="step-title">Preparing</div>
                  <div class="step-desc">File sliced and validated</div>
                  <div class="step-time">Jan 15, 10:15 AM</div>
                </div>
              </div>
              <div class="step active">
                <div class="step-dot">‚óè</div>
                <div class="step-content">
                  <div class="step-title">Printing</div>
                  <div class="step-desc">Currently on layer 134</div>
                  <div class="step-time">In Progress</div>
                </div>
              </div>
              <div class="step">
                <div class="step-dot"></div>
                <div class="step-content">
                  <div class="step-title">Quality Check</div>
                  <div class="step-desc">Post-print inspection</div>
                  <div class="step-time">Pending</div>
                </div>
              </div>
              <div class="step">
                <div class="step-dot"></div>
                <div class="step-content">
                  <div class="step-title">Ready for Pickup</div>
                  <div class="step-desc">Your order is ready!</div>
                  <div class="step-time">Pending</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="side-panel">
          <!-- Print Stats -->
          <div class="print-stats-card">
            <h3>üîß Print Stats</h3>
            <div class="stat-row">
              <span class="stat-label">Nozzle Temp</span>
              <span class="stat-value">
                <span class="temp-indicator"></span>
                <span id="nozzleTemp">200¬∞C</span>
              </span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Bed Temp</span>
              <span class="stat-value">
                <span class="temp-indicator"></span>
                <span id="bedTemp">60¬∞C</span>
              </span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Layer Height</span>
              <span class="stat-value">0.2mm</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Print Speed</span>
              <span class="stat-value" id="printSpeed">60mm/s</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Material Used</span>
              <span class="stat-value" id="materialUsed">89g</span>
            </div>
          </div>
          
          <!-- ETA Countdown -->
          <div class="eta-card">
            <h3>‚è±Ô∏è Estimated Completion</h3>
            <div class="countdown">
              <div class="countdown-main" id="countdown">02:34:12</div>
              <div class="countdown-label">hours remaining</div>
            </div>
          </div>
          
          <!-- G-Code Stream -->
          <div class="gcode-card">
            <h3>üì° Live G-Code</h3>
            <div class="gcode-terminal" id="gcodeTerminal">
              <div class="gcode-line">; MagniPrints Printer v2.1</div>
              <div class="gcode-line">M104 S200 <span class="gcode-comment">; Set nozzle temp</span></div>
              <div class="gcode-line">M140 S60 <span class="gcode-comment">; Set bed temp</span></div>
              <div class="gcode-line active">G1 X45.2 Y23.4 E0.24 <span class="gcode-comment">; Extrude</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/theme.js"></script>
  
  <script>
    // ========================================
    // DEMO ORDER DATA
    // ========================================
    const demoOrders = {
      'MP-001': {
        id: 'MP-001',
        product: 'Controller Stand x 2',
        date: 'Jan 15, 2026',
        progress: 67,
        currentLayer: 134,
        totalLayers: 200,
        status: 'printing',
        statusText: 'Printing',
        stepActive: 2, // 0-indexed, printing is step 2
        eta: '02:34:12',
        nozzleTemp: '200¬∞C',
        bedTemp: '60¬∞C',
        speed: '60mm/s',
        materialUsed: '89g',
        steps: [
          { title: 'Order Received', desc: 'Your order has been confirmed', time: 'Jan 15, 9:30 AM', completed: true },
          { title: 'Preparing', desc: 'File sliced and validated', time: 'Jan 15, 10:15 AM', completed: true },
          { title: 'Printing', desc: 'Currently on layer 134', time: 'In Progress', completed: false, active: true },
          { title: 'Quality Check', desc: 'Post-print inspection', time: 'Pending', completed: false },
          { title: 'Ready for Pickup', desc: 'Your order is ready!', time: 'Pending', completed: false }
        ]
      },
      'MP-002': {
        id: 'MP-002',
        product: 'Lithophane Frame x 1',
        date: 'Jan 14, 2026',
        progress: 100,
        currentLayer: 400,
        totalLayers: 400,
        status: 'ready',
        statusText: 'Ready for Pickup',
        stepActive: 4,
        eta: '00:00:00',
        nozzleTemp: '195¬∞C',
        bedTemp: '55¬∞C',
        speed: '40mm/s',
        materialUsed: '62g',
        steps: [
          { title: 'Order Received', desc: 'Your order has been confirmed', time: 'Jan 14, 2:30 PM', completed: true },
          { title: 'Preparing', desc: 'File sliced and validated', time: 'Jan 14, 3:00 PM', completed: true },
          { title: 'Printing', desc: 'Completed', time: 'Jan 15, 8:00 AM', completed: true },
          { title: 'Quality Check', desc: 'Passed inspection', time: 'Jan 15, 9:30 AM', completed: true },
          { title: 'Ready for Pickup', desc: 'Your order is ready!', time: 'Jan 15, 10:00 AM', completed: true, active: true }
        ]
      },
      'MP-003': {
        id: 'MP-003',
        product: 'Desk Organizer x 1',
        date: 'Jan 15, 2026',
        progress: 23,
        currentLayer: 46,
        totalLayers: 200,
        status: 'queued',
        statusText: 'Printing (Queued)',
        stepActive: 2,
        eta: '08:45:30',
        nozzleTemp: '200¬∞C',
        bedTemp: '60¬∞C',
        speed: '60mm/s',
        materialUsed: '41g',
        steps: [
          { title: 'Order Received', desc: 'Your order has been confirmed', time: 'Jan 15, 11:00 AM', completed: true },
          { title: 'Preparing', desc: 'File sliced and validated', time: 'Jan 15, 11:15 AM', completed: true },
          { title: 'Printing', desc: 'Starting print (layer 46)', time: 'In Progress', completed: false, active: true },
          { title: 'Quality Check', desc: 'Post-print inspection', time: 'Pending', completed: false },
          { title: 'Ready for Pickup', desc: 'Your order is ready!', time: 'Pending', completed: false }
        ]
      }
    };
    
    let currentOrder = null;
    let layerAnimationId = null;
    let gcodeInterval = null;
    
    // ========================================
    // ORDER TRACKING
    // ========================================
    document.getElementById('trackBtn').addEventListener('click', trackOrder);
    document.getElementById('orderInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') trackOrder();
    });
    
    function fillOrder(id) {
      document.getElementById('orderInput').value = id;
      trackOrder();
    }
    
    window.fillOrder = fillOrder;
    
    function trackOrder() {
      const input = document.getElementById('orderInput').value.toUpperCase();
      const order = demoOrders[input] || demoOrders['MP-001']; // Default to demo
      
      currentOrder = order;
      displayOrder(order);
    }
    
    function displayOrder(order) {
      document.getElementById('displayOrderId').textContent = order.id;
      document.getElementById('statusBadge').className = `order-status-badge ${order.status}`;
      document.getElementById('statusText').textContent = order.statusText;
      
      // Update stats
      document.getElementById('nozzleTemp').textContent = order.nozzleTemp;
      document.getElementById('bedTemp').textContent = order.bedTemp;
      document.getElementById('printSpeed').textContent = order.speed;
      document.getElementById('materialUsed').textContent = order.materialUsed;
      document.getElementById('countdown').textContent = order.eta;
      
      // Build progress steps
      const stepsHtml = order.steps.map((step, i) => `
        <div class="step ${step.completed ? 'completed' : ''} ${step.active ? 'active' : ''}">
          <div class="step-dot">${step.completed ? '‚úì' : step.active ? '‚óè' : ''}</div>
          <div class="step-content">
            <div class="step-title">${step.title}</div>
            <div class="step-desc">${step.desc}</div>
            <div class="step-time">${step.time}</div>
          </div>
        </div>
      `).join('');
      document.getElementById('stepsContainer').innerHTML = stepsHtml;
      
      // Show display
      document.getElementById('orderDisplay').classList.add('visible');
      
      // Start visualization
      startLayerVisualization(order);
      startGCodeStream();
    }
    
    // ========================================
    // 3D LAYER VISUALIZATION (Canvas)
    // ========================================
    function startLayerVisualization(order) {
      if (layerAnimationId) cancelAnimationFrame(layerAnimationId);
      
      const canvas = document.getElementById('layerCanvas');
      const ctx = canvas.getContext('2d');
      const dpr = Math.min(window.devicePixelRatio, 2);
      
      // Set canvas size
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      
      const width = rect.width;
      const height = rect.height;
      
      // Layer parameters
      const totalLayers = order.totalLayers;
      let currentLayer = order.currentLayer;
      const layerHeight = 3;
      const perspective = 0.6;
      
      function draw() {
        ctx.clearRect(0, 0, width, height);
        
        const centerX = width / 2;
        const centerY = height / 2 + 50;
        
        // Draw completed layers from bottom to top
        const maxVisibleLayers = Math.min(totalLayers, Math.floor(height / (layerHeight * 0.6)));
        const startLayer = Math.max(0, currentLayer - maxVisibleLayers);
        
        for (let i = startLayer; i < currentLayer; i++) {
          const layerIndex = i - startLayer;
          const y = centerY - layerIndex * layerHeight * perspective;
          const xOffset = layerIndex * 2;
          
          // Layer color gradient - darker at bottom, lighter at top
          const colorRatio = i / totalLayers;
          const hue = 230;
          const lightness = 30 + colorRatio * 30;
          
          // Draw layer (rounded rectangle with perspective)
          ctx.beginPath();
          const layerWidth = 140 + xOffset;
          const layerDepth = 100 + xOffset * 0.6;
          
          ctx.fillStyle = `hsl(${hue}, 40%, ${lightness}%)`;
          
          // Draw as perspective trapezoid
          ctx.moveTo(centerX - layerWidth/2 + xOffset, y);
          ctx.lineTo(centerX + layerWidth/2 + xOffset, y);
          ctx.lineTo(centerX + layerWidth/2 + xOffset - 10, y + layerHeight * perspective);
          ctx.lineTo(centerX - layerWidth/2 + xOffset + 10, y + layerHeight * perspective);
          ctx.closePath();
          ctx.fill();
          
          // Add highlight to top layer
          if (i === currentLayer - 1) {
            ctx.strokeStyle = 'var(--accent)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Glow effect
            ctx.shadowColor = 'var(--accent)';
            ctx.shadowBlur = 20;
            ctx.stroke();
            ctx.shadowBlur = 0;
          }
        }
        
        // Draw nozzle position
        const topY = centerY - (currentLayer - startLayer - 1) * layerHeight * perspective - 5;
        const topXOffset = (currentLayer - startLayer - 1) * 2;
        
        // Nozzle
        ctx.fillStyle = '#ff6b6b';
        ctx.beginPath();
        ctx.moveTo(centerX - 8 + topXOffset, topY - 15);
        ctx.lineTo(centerX + 8 + topXOffset, topY - 15);
        ctx.lineTo(centerX + topXOffset, topY);
        ctx.closePath();
        ctx.fill();
        
        // Hot end glow
        ctx.beginPath();
        ctx.arc(centerX + topXOffset, topY + 5, 4, 0, Math.PI * 2);
        ctx.fillStyle = '#ffd93d';
        ctx.fill();
        
        // Animate if not complete
        if (currentOrder.status !== 'ready' && Math.random() > 0.95) {
          currentLayer = Math.min(totalLayers, currentLayer + 1);
        }
        
        // Update display
        const progress = Math.round((currentLayer / totalLayers) * 100);
        document.getElementById('progressPct').textContent = `${progress}%`;
        document.getElementById('progressText').textContent = `Layer ${currentLayer}/${totalLayers}`;
        
        layerAnimationId = requestAnimationFrame(draw);
      }
      
      draw();
    }
    
    // ========================================
    // G-CODE STREAM SIMULATION
    // ========================================
    const gcodeCommands = [
      { cmd: 'G1 X{:.1f} Y{:.1f} E{:.2f}', comment: 'Extrude' },
      { cmd: 'G1 X{:.1f} Y{:.1f} F1500', comment: 'Move' },
      { cmd: 'G1 E-0.2', comment: 'Retract' },
      { cmd: 'G1 Z{:.2f}', comment: 'Lift Z' },
      { cmd: 'M104 S{:.0f}', comment: 'Adjust temp' }
    ];
    
    function startGCodeStream() {
      if (gcodeInterval) clearInterval(gcodeInterval);
      
      const terminal = document.getElementById('gcodeTerminal');
      let lines = [];
      
      gcodeInterval = setInterval(() => {
        // Generate random G-code line
        const template = gcodeCommands[Math.floor(Math.random() * gcodeCommands.length)];
        const x = (Math.random() * 100).toFixed(1);
        const y = (Math.random() * 100).toFixed(1);
        const e = (Math.random() * 2).toFixed(2);
        const z = (currentOrder?.currentLayer * 0.2).toFixed(2);
        const t = (195 + Math.random() * 10).toFixed(0);
        
        let cmd = template.cmd
          .replace('{:.1f}', x).replace('{:.1f}', y).replace('{:.2f}', e)
          .replace('{:.2f}', z).replace('{:.0f}', t);
        
        lines.push({ cmd, comment: template.comment });
        if (lines.length > 5) lines.shift();
        
        terminal.innerHTML = lines.map((line, i) => 
          `<div class="gcode-line ${i === lines.length - 1 ? 'active' : ''}">
            ${line.cmd} <span class="gcode-comment">; ${line.comment}</span>
          </div>`
        ).join('');
        
        // Randomly update temps
        if (Math.random() > 0.7) {
          const variation = Math.floor(Math.random() * 3) - 1;
          const currentTemp = parseInt(document.getElementById('nozzleTemp').textContent);
          document.getElementById('nozzleTemp').textContent = `${currentTemp + variation}¬∞C`;
        }
        
        // Update material used
        if (currentOrder && currentOrder.status !== 'ready') {
          const currentMat = parseInt(document.getElementById('materialUsed').textContent);
          if (Math.random() > 0.8) {
            document.getElementById('materialUsed').textContent = `${currentMat + 1}g`;
          }
        }
      }, 800);
    }
    
    // ========================================
    // RESIZE HANDLER
    // ========================================
    window.addEventListener('resize', () => {
      if (currentOrder) {
        setTimeout(() => startLayerVisualization(currentOrder), 100);
      }
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (layerAnimationId) cancelAnimationFrame(layerAnimationId);
      if (gcodeInterval) clearInterval(gcodeInterval);
    });
  </script>
</body>
</html>
