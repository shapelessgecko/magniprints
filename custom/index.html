<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Custom Print | MAGNIPRINTS</title>
  <meta name="description" content="Upload your STL file for custom 3D printing. Get instant quotes on your designs.">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Sans+JP:wght@700;900&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  
  <link rel="stylesheet" href="../css/theme.css">
  
  <style>
    .custom-page {
      min-height: 100vh;
      padding-top: 100px;
      padding-bottom: 4rem;
    }
    
    .page-header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 0 2rem;
    }
    
    .page-header h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    
    .back-link:hover {
      color: var(--accent);
    }
    
    .custom-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }
    
    /* Upload Zone */
    .upload-zone {
      background: var(--bg-card);
      border: 2px dashed var(--border);
      border-radius: 24px;
      padding: 4rem 2rem;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 2rem;
    }
    
    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--accent);
      background: var(--bg-tertiary);
    }
    
    .upload-zone.dragover {
      box-shadow: 0 0 30px var(--accent-glow);
    }
    
    .upload-zone .icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.7;
    }
    
    .upload-zone h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .upload-zone p {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }
    
    .upload-btn {
      padding: 0.75rem 2rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .upload-btn:hover {
      border-color: var(--accent);
      background: var(--accent);
      color: white;
    }
    
    #fileInput {
      display: none;
    }
    
    /* 3D Preview */
    .preview-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 24px;
      overflow: hidden;
      height: 600px;
      position: relative;
    }
    
    #preview-canvas {
      width: 100%;
      height: 100%;
    }
    
    .preview-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
    }
    
    .preview-placeholder .icon {
      font-size: 5rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .preview-controls {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0.5rem;
      background: var(--bg-primary);
      padding: 0.5rem;
      border-radius: 30px;
      border: 1px solid var(--border);
    }
    
    .preview-control-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }
    
    .preview-control-btn:hover {
      background: var(--accent);
      color: white;
    }
    
    /* Sample Models */
    .samples-section {
      margin-top: 2rem;
    }
    
    .samples-section h3 {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .samples-grid {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .sample-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    
    .sample-btn:hover {
      border-color: var(--accent);
      background: var(--accent);
      color: white;
    }
    
    /* Calculation Panel */
    .calc-panel {
      position: sticky;
      top: 100px;
      height: fit-content;
    }
    
    .calc-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .calc-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.875rem 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    
    /* Range Sliders */
    .range-group {
      margin-bottom: 1rem;
    }
    
    .range-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .range-header label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .range-value {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent);
      padding: 0.25rem 0.75rem;
      background: var(--bg-secondary);
      border-radius: 20px;
    }
    
    input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--bg-secondary);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 10px var(--accent-glow);
    }
    
    /* Cost Summary */
    .cost-summary {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 1.25rem;
      margin-top: 1rem;
    }
    
    .cost-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .cost-row.total {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--accent);
    }
    
    /* Print Specs Preview */
    .print-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-top: 1rem;
    }
    
    .stat {
      background: var(--bg-secondary);
      padding: 0.75rem;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-top: 0.25rem;
    }
    
    /* Order Button */
    .order-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 1.5rem;
    }
    
    .file-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    
    .file-icon {
      font-size: 1.5rem;
    }
    
    .file-details {
      flex: 1;
    }
    
    .file-name {
      font-weight: 600;
      font-size: 0.9rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .file-size {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    
    .remove-file {
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0.25rem;
    }
    
    .whatsapp-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(37, 211, 102, 0.3);
    }
    
    .whatsapp-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    @media (max-width: 1024px) {
      .custom-layout {
        grid-template-columns: 1fr;
      }
      
      .calc-panel {
        position: relative;
        top: 0;
      }
      
      .preview-container {
        height: 400px;
      }
    }
    
    @media (max-width: 768px) {
      .preview-container {
        height: 300px;
      }
      
      .samples-grid {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav-container">
    <a href="../index.html" class="logo">
      <span>‚óâ</span> MAGNIPRINTS
    </a>
    <ul class="nav-links">
      <li><a href="../index.html">Home</a></li>
      <li><a href="../products/index.html">Products</a></li>
      <li><a href="index.html">Custom</a></li>
      <li><a href="../track/index.html">Track</a></li>
    </ul>
  </nav>

  <div class="custom-page">
    <div class="page-header">
      <a href="../index.html" class="back-link">‚Üê Back to Home</a>
      <h1>Custom <span class="text-gradient">Print</span></h1>
      <p>Upload your STL file or try our sample models</p>
    </div>
    
    <div class="custom-layout">
      <div class="left-col">
        <!-- Upload Zone -->
        <div class="upload-zone" id="uploadZone">
          <div class="icon">üì§</div>
          <h3>Drop your STL file here</h3>
          <p>or click to browse (max 20MB)</p>
          <button class="upload-btn">Select File</button>
          <input type="file" id="fileInput" accept=".stl,.STL,.obj,.OBJ">
        </div>
        
        <!-- 3D Preview -->
        <div class="preview-container">
          <div class="preview-placeholder" id="previewPlaceholder">
            <div class="icon">üßä</div>
            <p>Upload an STL file or select a sample model to preview</p>
          </div>
          <div id="preview-canvas" style="display: none;"></div>
          
          <div class="preview-controls" id="previewControls" style="display: none;">
            <button class="preview-control-btn" id="resetView">‚ü≤</button>
            <button class="preview-control-btn" id="zoomIn">+</button>
            <button class="preview-control-btn" id="zoomOut">‚àí</button>
            <button class="preview-control-btn" id="toggleWireframe">‚ó´</button>
          </div>
        </div>
        
        <!-- Sample Models -->
        <div class="samples-section">
          <h3>Try a Sample Model</h3>
          <div class="samples-grid">
            <button class="sample-btn" onclick="loadSample('phoneStand')">
              <span>üì±</span> Phone Stand
            </button>
            <button class="sample-btn" onclick="loadSample('sampleVase')">
              <span>üè∫</span> Vase
            </button>
            <button class="sample-btn" onclick="loadSample('sampleFigurine')">
              <span>üé≠</span> Figurine
            </button>
          </div>
        </div>
      </div>
      
      <div class="calc-panel">
        <!-- Print Settings -->
        <div class="calc-card">
          <h3>‚öôÔ∏è Print Settings</h3>
          
          <div class="form-group">
            <label>Filament Material</label>
            <select id="materialSelect">
              <option value="pla" data-rate="3">PLA (Standard) - ‚Çπ3/g</option>
              <option value="petg" data-rate="4">PETG (Strong) - ‚Çπ4/g</option>
              <option value="tpu" data-rate="5">TPU (Flexible) - ‚Çπ5/g</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Estimated Weight (grams)</label>
            <input type="number" id="weightInput" value="50" min="1" max="1000" placeholder="Enter weight in grams">
          </div>
          
          <div class="range-group">
            <div class="range-header">
              <label>Layer Height</label>
              <span class="range-value" id="layerValue">0.2mm</span>
            </div>
            <input type="range" id="layerRange" min="0.1" max="0.3" step="0.1" value="0.2" 
                   oninput="updateLayerDisplay(this.value)">
          </div>
          
          <div class="range-group">
            <div class="range-header">
              <label>Infill %</label>
              <span class="range-value" id="infillValue">20%</span>
            </div>
            <input type="range" id="infillRange" min="0" max="100" step="5" value="20"
                   oninput="updateInfillDisplay(this.value)">
          </div>
          
          <div class="cost-summary">
            <div class="cost-row">
              <span>Material Cost</span>
              <span id="materialCost">‚Çπ150</span>
            </div>
            <div class="cost-row">
              <span>Setup Fee</span>
              <span>‚Çπ50</span>
            </div>
            <div class="cost-row total">
              <span>Total</span>
              <span id="totalCost">‚Çπ200</span>
            </div>
          </div>
          
          <div class="print-stats">
            <div class="stat">
              <div class="stat-label">Time</div>
              <div class="stat-value" id="estTime">3h</div>
            </div>
            <div class="stat">
              <div class="stat-label">Layers</div>
              <div class="stat-value" id="estLayers">~400</div>
            </div>
            <div class="stat">
              <div class="stat-label">Nozzle</div>
              <div class="stat-value">200¬∞C</div>
            </div>
            <div class="stat">
              <div class="stat-label">Bed</div>
              <div class="stat-value">60¬∞C</div>
            </div>
          </div>
        </div>
        
        <!-- Order Section -->
        <div class="order-section">
          <h3>üì¶ Order Details</h3>
          
          <div class="form-group">
            <label>Your Name</label>
            <input type="text" id="customerName" placeholder="Enter your name">
          </div>
          
          <div class="form-group">
            <label>Additional Notes</label>
            <input type="text" id="orderNotes" placeholder="Color preference, special requests...">
          </div>
          
          <button class="whatsapp-btn" id="orderBtn" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.35-8.413"/>
            </svg>
            Send Order via WhatsApp
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/theme.js"></script>
  <script src="../js/3d-utils.js"></script>
  
  <script>
    // ========================================
    // STATE
    // ========================================
    let scene, camera, renderer, controls, currentMesh;
    let currentFile = null;
    let isWireframe = false;
    
    // ========================================
    // UPLOAD ZONE
    // ========================================
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    
    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && (file.name.endsWith('.stl') || file.name.endsWith('.STL'))) {
        handleFile(file);
      }
    });
    
    fileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) {
        handleFile(e.target.files[0]);
      }
    });
    
    function handleFile(file) {
      currentFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        loadSTL(e.target.result, file.name);
        document.getElementById('orderBtn').disabled = false;
      };
      reader.readAsArrayBuffer(file);
    }
    
    // ========================================
    // THREE.JS SETUP
    // ========================================
    function initThreeJS() {
      if (renderer) return;
      
      const container = document.getElementById('preview-canvas');
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      scene = new THREE.Scene();
      scene.background = new THREE.Color(getComputedStyle(document.body).getPropertyValue('--bg-card').trim());
      
      camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
      camera.position.set(15, 15, 15);
      
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(width, height);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.shadowMap.enabled = true;
      container.appendChild(renderer.domElement);
      
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      
      // Lights
      const ambient = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambient);
      
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(10, 20, 10);
      dirLight.castShadow = true;
      scene.add(dirLight);
      
      const fillLight = new THREE.DirectionalLight(0x667eea, 0.3);
      fillLight.position.set(-10, 0, -10);
      scene.add(fillLight);
      
      // Ground
      const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(50, 50),
        new THREE.ShadowMaterial({ opacity: 0.2 })
      );
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = -0.01;
      ground.receiveShadow = true;
      scene.add(ground);
      
      animate();
    }
    
    function animate() {
      requestAnimationFrame(animate);
      if (controls) controls.update();
      if (renderer && scene && camera) renderer.render(scene, camera);
    }
    
    function loadSTL(data, filename) {
      initThreeJS();
      
      document.getElementById('previewPlaceholder').style.display = 'none';
      document.getElementById('preview-canvas').style.display = 'block';
      document.getElementById('previewControls').style.display = 'flex';
      
      if (currentMesh) {
        scene.remove(currentMesh);
      }
      
      const loader = new THREE.STLLoader();
      const geometry = loader.parse(data);
      
      const material = new THREE.MeshStandardMaterial({
        color: 0x2a2a2a,
        roughness: 0.5,
        metalness: 0.2
      });
      
      currentMesh = new THREE.Mesh(geometry, material);
      currentMesh.castShadow = true;
      currentMesh.receiveShadow = true;
      
      // Center and scale
      geometry.computeBoundingBox();
      const box = geometry.boundingBox;
      const center = new THREE.Vector3();
      box.getCenter(center);
      currentMesh.position.sub(center);
      currentMesh.position.y = (box.max.y - box.min.y) / 2;
      
      // Auto-calculate weight based on volume (rough estimate)
      const volume = getVolume(geometry);
      const weight = Math.round(volume * 1.25); // PLA density ~1.25 g/cm¬≥
      
      // Update inputs
      document.getElementById('weightInput').value = weight || 50;
      updatePrice();
      
      scene.add(currentMesh);
      
      // Reset camera
      const size = box.max.distanceTo(box.min);
      camera.position.set(size, size, size);
      controls.reset();
      
      // Show file info
      showFileInfo(filename);
    }
    
    function getVolume(geometry) {
      let volume = 0;
      const position = geometry.attributes.position;
      for (let i = 0; i < position.count; i += 3) {
        const a = new THREE.Vector3(), b = new THREE.Vector3(), c = new THREE.Vector3();
        a.fromBufferAttribute(position, i);
        b.fromBufferAttribute(position, i + 1);
        c.fromBufferAttribute(position, i + 2);
        volume += Math.abs(a.dot(b.cross(c))) / 6;
      }
      return volume / 1000; // Convert to cm¬≥
    }
    
    function loadSample(modelName) {
      initThreeJS();
      
      document.getElementById('previewPlaceholder').style.display = 'none';
      document.getElementById('preview-canvas').style.display = 'block';
      document.getElementById('previewControls').style.display = 'flex';
      
      if (currentMesh) {
        scene.remove(currentMesh);
      }
      
      const material = new THREE.MeshStandardMaterial({
        color: 0x2a2a2a,
        roughness: 0.5,
        metalness: 0.2
      });
      
      // Use the procedural model generator
      currentMesh = ProductModels[modelName](scene, material);
      currentMesh.traverse(child => {
        if (child.isMesh) {
          child.castShadow = true;
          child.receiveShadow = true;
        }
      });
      
      // Center the model
      const box = new THREE.Box3().setFromObject(currentMesh);
      const center = box.getCenter(new THREE.Vector3());
      currentMesh.position.sub(center);
      currentMesh.position.y = (box.max.y - box.min.y) / 2;
      
      scene.add(currentMesh);
      
      camera.position.set(15, 15, 15);
      controls.reset();
      
      document.getElementById('orderBtn').disabled = false;
      showFileInfo(modelName === 'phoneStand' ? 'Phone Stand.stl' : 
                   modelName === 'sampleVase' ? 'Vase.stl' : 'Figurine.stl');
    }
    
    window.loadSample = loadSample;
    
    function showFileInfo(name) {
      // Could show file details in UI
    }
    
    // ========================================
    // PRICE CALCULATOR
    // ========================================
    function updatePrice() {
      const material = document.getElementById('materialSelect');
      const rate = parseInt(material.options[material.selectedIndex].dataset.rate);
      const weight = parseInt(document.getElementById('weightInput').value) || 0;
      
      const materialCost = weight * rate;
      const setupFee = 50;
      const total = materialCost + setupFee;
      
      document.getElementById('materialCost').textContent = `‚Çπ${materialCost}`;
      document.getElementById('totalCost').textContent = `‚Çπ${total}`;
      
      // Update estimated time
      const layerHeight = parseFloat(document.getElementById('layerRange').value);
      const infill = parseInt(document.getElementById('infillRange').value);
      const hours = Math.max(1, Math.round((weight * 0.08) * (0.2 / layerHeight) * (1 + infill / 200)));
      document.getElementById('estTime').textContent = hours < 24 ? `${hours}h` : `${Math.round(hours/24)}d`;
      
      // Update layer count
      const height = 50; // Estimate
      document.getElementById('estLayers').textContent = `~${Math.round(height / layerHeight)}`;
    }
    
    function updateLayerDisplay(val) {
      document.getElementById('layerValue').textContent = `${val}mm`;
      updatePrice();
    }
    
    function updateInfillDisplay(val) {
      document.getElementById('infillValue').textContent = `${val}%`;
      updatePrice();
    }
    
    window.updateLayerDisplay = updateLayerDisplay;
    window.updateInfillDisplay = updateInfillDisplay;
    
    // Event listeners
    document.getElementById('materialSelect').addEventListener('change', updatePrice);
    document.getElementById('weightInput').addEventListener('input', updatePrice);
    
    // ========================================
    // PREVIEW CONTROLS
    // ========================================
    document.getElementById('resetView').addEventListener('click', () => {
      if (controls) controls.reset();
    });
    
    document.getElementById('zoomIn').addEventListener('click', () => {
      if (camera) camera.position.multiplyScalar(0.8);
    });
    
    document.getElementById('zoomOut').addEventListener('click', () => {
      if (camera) camera.position.multiplyScalar(1.2);
    });
    
    document.getElementById('toggleWireframe').addEventListener('click', () => {
      if (currentMesh) {
        isWireframe = !isWireframe;
        currentMesh.traverse(child => {
          if (child.isMesh && child.material) {
            child.material.wireframe = isWireframe;
          }
        });
      }
    });
    
    // ========================================
    // ORDER BUTTON
    // ========================================
    document.getElementById('orderBtn').addEventListener('click', () => {
      const material = document.getElementById('materialSelect').value.toUpperCase();
      const weight = document.getElementById('weightInput').value;
      const layerHeight = document.getElementById('layerRange').value;
      const infill = document.getElementById('infillRange').value;
      const total = document.getElementById('totalCost').textContent;
      const name = document.getElementById('customerName').value || 'Customer';
      const notes = document.getElementById('orderNotes').value;
      const filename = currentFile ? currentFile.name : 'sample-model.stl';
      
      const message = `Hello MagniPrints! üëã

*Custom Print Order*
üë§ Name: ${name}
üìÅ File: ${filename}
üé® Material: ${material}
‚öñÔ∏è Weight: ${weight}g
üìê Layer Height: ${layerHeight}mm
üî≤ Infill: ${infill}%
üí∞ Total: ${total}
${notes ? 'üìù Notes: ' + notes : ''}

Please confirm my order and provide delivery timeline.`;
      
      const encodedMessage = encodeURIComponent(message);
      window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    });
    
    // Resize handler
    window.addEventListener('resize', () => {
      if (renderer && camera) {
        const container = document.getElementById('preview-canvas');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
      }
    });
    
    // Init
    updatePrice();
  </script>
</body>
</html>
